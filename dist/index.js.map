{"version":3,"file":"index.js","sources":["../src/printField.ts","../src/printMethod.ts","../src/mock.ts","../src/index.ts","../src/printEnum.ts"],"sourcesContent":["import { IType, IField, IMapField } from 'protobufjs';\n\nconst TYPES: {\n  [key: string]: string;\n} = {\n  double: 'number',\n  float: 'number',\n  int32: 'number',\n  int64: 'number',\n  uint32: 'number',\n  uint64: 'number',\n  sint32: 'number',\n  sint64: 'number',\n  fixed32: 'number',\n  fixed64: 'number',\n  sfixed32: 'number',\n  sfixed64: 'number',\n  bool: 'boolean',\n  string: 'string',\n  bytes: 'string'\n};\n\nfunction getKeyType(p: Partial<IMapField>) {\n  if (p.keyType) {\n    return TYPES[p.keyType] || p.keyType;\n  }\n  return '';\n}\n\nfunction readField(\n  name: string,\n  content: {\n    [k: string]: IField;\n  }\n) {\n  const params = Object.keys(content).map(paramName => {\n    const paramValue = content[paramName];\n\n    return {\n      type: TYPES[paramValue.type] || paramValue.type,\n      keyType: getKeyType(paramValue),\n      name: paramName,\n      rule: paramValue.rule,\n      id: paramValue.id\n    };\n  });\n\n  return {\n    category: 'fields',\n    name: name,\n    params: params.sort((a, b) => a.id - b.id)\n  };\n}\n\nexport function printField(name: string, fieldParams: IType) {\n  const content = fieldParams.fields;\n\n  const item = readField(name, content);\n\n  const strs = item.params.map(param => {\n    if (param.rule === 'repeated') {\n      return `  ${param.name}: ${param.type}[];\\n`;\n    }\n    if (param.keyType) {\n      return `  ${param.name}: {[key: ${param.keyType}]: ${param.type}};\\n`;\n    }\n    return `  ${param.name}: ${param.type};\\n`;\n  });\n\n  if (fieldParams.nested) {\n    Object.keys(fieldParams.nested).forEach(key => {\n      strs.push(`  ${key}: ${key};\\n`);\n    });\n  }\n\n  return `interface ${item.name} {\\n${strs.join('')}}\\n\\n`;\n}\n","import { IService, IMethod } from 'protobufjs';\n\nconst EMPTY = 'google.protobuf.Empty';\n\nfunction readMethod(\n  name: string,\n  content: {\n    [k: string]: IMethod;\n  }\n) {\n  const params = Object.keys(content).map(paramName => {\n    const paramValue = content[paramName];\n\n    return { name: paramName, ...paramValue };\n  });\n\n  return {\n    category: 'methods',\n    name: name,\n    params\n  };\n}\n\nexport function printMethod(name: string, methodContent: IService) {\n  const content = methodContent.methods;\n  const item = readMethod(name, content);\n\n  const strs = item.params.map(param => {\n    const requestType =\n      param.requestType === EMPTY ? '' : `params: ${param.requestType}`;\n    const responseType =\n      param.responseType === EMPTY ? '{}' : param.responseType;\n    return (\n      `interface ${param.name} {\\n` +\n      `  (${requestType}): Promise<${responseType}>;\\n` +\n      `}\\n` +\n      `\\n`\n    );\n  });\n\n  return `${strs.join('')}`;\n}\n","import protobuf, { Service } from 'protobufjs';\n\nfunction _getAllMethods(root: protobuf.Root) {\n  const service = root.nestedArray.find(s => s instanceof Service);\n  const firstService = root.lookupService(service!.name);\n\n  return firstService.methods;\n}\n\nexport function getAllMethods(source: string) {\n  const res = protobuf.parse(source, {\n    keepCase: true,\n    alternateCommentMode: true\n  });\n  if (res.package) {\n    const reflect = res.root.lookup(res.package) as protobuf.Root;\n    return _getAllMethods(reflect);\n  }\n  return _getAllMethods(res.root);\n}\n\nfunction mockScalar(type: string): any {\n  switch (type) {\n    case 'string':\n      return 'Hello';\n    case 'number':\n      return 10;\n    case 'bool':\n      return true;\n    case 'int32':\n      return 10;\n    case 'int64':\n      return 20;\n    case 'uint32':\n      return 100;\n    case 'uint64':\n      return 100;\n    case 'sint32':\n      return 100;\n    case 'sint64':\n      return 1200;\n    case 'fixed32':\n      return 1400;\n    case 'fixed64':\n      return 1500;\n    case 'sfixed32':\n      return 1600;\n    case 'sfixed64':\n      return 1700;\n    case 'double':\n      return 1.4;\n    case 'float':\n      return 1.1;\n    case 'bytes':\n      return new Buffer('Hello');\n    default:\n      return null;\n  }\n}\n\nfunction mockType(root: protobuf.Root, typeName: string): Object {\n  const type = root.lookupType(typeName);\n\n  return type.fieldsArray.reduce((a, b) => {\n    const mockData = mockScalar(b.type);\n    const val = mockData\n      ? { [b.name]: mockData }\n      : { [b.name]: mockType(root, b.type) };\n    return { ...a, ...val };\n  }, {});\n}\n\nfunction _mockResponse(root: protobuf.Root, methodName: string) {\n  const service = root.nestedArray.find(s => s instanceof Service);\n  const firstService = root.lookupService(service!.name);\n  const { responseType } = firstService.methods[methodName];\n  const res = mockType(root, responseType);\n  console.log(res);\n  return res;\n}\n\nexport function mockResponse(source: string, methodName: string) {\n  const res = protobuf.parse(source, {\n    keepCase: true,\n    alternateCommentMode: true\n  });\n  if (res.package) {\n    console.log(res.package);\n    const reflect = res.root.lookup(res.package) as protobuf.Root;\n    return _mockResponse(reflect, methodName);\n  }\n  return _mockResponse(res.root, methodName);\n}\n","import protobuf, { IService, IType, IEnum } from 'protobufjs';\nimport { printField } from './printField';\nimport { printMethod } from './printMethod';\nimport { printEnum } from './printEnum';\nimport { getAllMethods, mockResponse } from './mock';\n\nexport function printTypescript(json: protobuf.INamespace): string {\n  const nested = json.nested;\n  if (nested) {\n    const output = Object.keys(nested)\n      .map(name => {\n        const value = nested[name];\n\n        const res = Object.keys(value).map(category => {\n          if (category === 'fields') return printField(name, value as IType);\n          if (category === 'methods')\n            return printMethod(name, value as IService);\n          if (category === 'values') return printEnum(name, value as IEnum);\n          if (category === 'nested') return printTypescript(value);\n        });\n        return res;\n      })\n      .reduce((a, b) => a.concat(b), [])\n      .join('');\n\n    return output;\n  }\n  return '';\n}\n\nexport function parseProto(source: string) {\n  const res = protobuf.parse(source, { keepCase: true });\n  if (res.package) {\n    const root = res.root.lookup(res.package);\n    return printTypescript(root!.toJSON());\n  }\n  // console.log(JSON.stringify(res.root.toJSON()));\n  return printTypescript(res.root.toJSON());\n}\n\nexport { getAllMethods, mockResponse };\n\nexport default {\n  parseProto,\n  getAllMethods,\n  mockResponse\n};\n","import { IEnum } from 'protobufjs';\n\nexport function printEnum(name: string, enumContent: IEnum) {\n  const content = enumContent.values;\n  const item = Object.keys(content)\n    .map(key => ({\n      name: key,\n      id: content[key]\n    }))\n    .sort((a, b) => a.id - b.id);\n  const strs = item.map(s => `  ${s.name} = ${s.id},\\n`).join('');\n  return `enum ${name} {\\n${strs}}\\n\\n`;\n}\n"],"names":["TYPES","double","float","int32","int64","uint32","uint64","sint32","sint64","fixed32","fixed64","sfixed32","sfixed64","bool","string","bytes","EMPTY","getAllMethods","source","root","service","res","protobuf","parse","keepCase","alternateCommentMode","package","lookup","nestedArray","find","s","Service","lookupService","name","methods","_mockResponse","methodName","firstService","mockType","typeName","lookupType","fieldsArray","reduce","a","b","mockData","type","Buffer","mockScalar","val","Object","console","log","mockResponse","printTypescript","json","nested","keys","map","value","category","fieldParams","item","content","params","paramName","p","paramValue","keyType","rule","id","sort","readField","fields","strs","param","forEach","key","push","join","printField","methodContent","readMethod","requestType","responseType","printMethod","enumContent","values","printEnum","concat","parseProto","toJSON"],"mappings":"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"}